<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chennai Rainfall Analytics V2</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
    <style>
        .chart-container {
            position: relative;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .rainfall-results {
            min-height: 200px;
        }
        .loading-message {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Navigation -->
        <div class="row">
            <div class="col-12">
                <div class="mb-3">
                    <a href="/" class="btn btn-outline-secondary">‚Üê Back to Super App</a>
                </div>
            </div>
        </div>
        
        <!-- Header -->
        <div class="row">
            <div class="col-12">
                <header class="text-center py-4">
                    <h1 class="display-4">üåßÔ∏è Chennai Rainfall Analytics V2</h1>
                    <p class="lead">100+ Years of Rainfall Data Analysis</p>
                    
                    <!-- Data Source Toggle -->
                    <div class="row justify-content-center mt-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body py-3">
                                    <h6 class="card-title mb-2">üìä Data Source Selection</h6>
                                    <div class="form-check form-switch d-inline-block me-3">
                                        <input class="form-check-input" type="radio" name="dataSource" id="csvDataSource" value="CSV" checked>
                                        <label class="form-check-label" for="csvDataSource">
                                            CSV Data (1901-2021)
                                        </label>
                                    </div>
                                    <div class="form-check form-switch d-inline-block">
                                        <input class="form-check-input" type="radio" name="dataSource" id="kwsDataSource" value="KWS">
                                        <label class="form-check-label" for="kwsDataSource">
                                            KWS Data (2000-2025)
                                        </label>
                                    </div>
                                    <div id="dataSourceStatus" class="mt-2 text-muted small">
                                        Current: CSV Data - Historical CSV rainfall data (1901-2021)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="row g-4">
            <!-- Left Column - Data Controls -->
            <div class="col-lg-4 col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">üìä Data Controls</h5>
                    </div>
                    <div class="card-body">
                        <div id="message" class="alert alert-info d-none"></div>
                        
                        <div class="mb-3">
                            <label for="year" class="form-label">Specific Year:</label>
                            <select id="year" class="form-select">
                                <option value="">All Years (Last 20)</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Year Range:</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="number" id="startYear" class="form-control" placeholder="Start Year" min="1901" max="2021">
                                </div>
                                <div class="col-6">
                                    <input type="number" id="endYear" class="form-control" placeholder="End Year" min="1901" max="2021">
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button id="fetchDataButton" class="btn btn-primary">Get Rainfall Data</button>
                            <button id="fetchStatsButton" class="btn btn-secondary">Get Statistics</button>
                            <button id="showAllChartsButton" class="btn btn-success">Show All Charts</button>
                            <button id="kwsRainfallAnalyticsButton" class="btn btn-info">üåê KWS Rainfall Analytics</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Center Column - Chart Controls -->
            <div class="col-lg-4 col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">üìà Chart Options</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Generate specific charts for detailed analysis:</p>
                        
                        <div class="d-grid gap-2">
                            <button id="annualChartButton" class="btn btn-outline-primary">üìä Annual Rainfall Trend (Chart.js)</button>
                            <button id="yearlySvgChartButton" class="btn btn-outline-primary">üìà Yearly Rainfall (SVG)</button>
                            <button id="monthlyChartButton" class="btn btn-outline-secondary">üìÖ Monthly Averages</button>
                            <div class="input-group mb-2 mt-2">
                                <span class="input-group-text">Month</span>
                                <select id="monthSelect" class="form-select" style="max-width:120px;">
                                    <option value="1">Jan</option>
                                    <option value="2">Feb</option>
                                    <option value="3">Mar</option>
                                    <option value="4">Apr</option>
                                    <option value="5">May</option>
                                    <option value="6">Jun</option>
                                    <option value="7">Jul</option>
                                    <option value="8">Aug</option>
                                    <option value="9">Sep</option>
                                    <option value="10">Oct</option>
                                    <option value="11">Nov</option>
                                    <option value="12">Dec</option>
                                </select>
                                <button id="monthlyTrendChartButton" class="btn btn-outline-warning">üìà Monthly Trend</button>
                            </div>
                            <div class="input-group mb-2">
                                <span class="input-group-text">Decade Offset</span>
                                <input type="number" id="decadeOffsetInput" class="form-control" min="0" max="9" value="0" style="max-width:70px;">
                                <button id="decadeOffsetChartButton" class="btn btn-outline-info">üìÜ Decade Comparison (Offset)</button>
                            </div>
                            <button id="decadeChartButton" class="btn btn-outline-info">üìÜ Decade Comparison (Standard)</button>
                            <button id="chennaiRainfallButton" class="btn btn-outline-success mt-2">üåßÔ∏è Chennai Rainfall Trend</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column - Quick Actions -->
            <div class="col-lg-4 col-md-12">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">‚ö° Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Quick access to common queries:</p>
                        <div class="d-grid gap-2">
                            <button id="recentYearsButton" class="btn btn-outline-warning">Last 10 Years</button>
                            <button id="centuryViewButton" class="btn btn-outline-danger">20th Century View</button>
                            <button id="modernEraButton" class="btn btn-outline-success">21st Century</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">üìä Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="rainfallData" class="rainfall-results">
                            <div class="loading-message">
                                <p>üëÜ Click any button above to start exploring Chennai rainfall data!</p>
                                <p class="text-muted">Available data: 1901-2021 (121 years)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
    <script>
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Populate year dropdown
            var yearSelect = document.getElementById('year');
            if (yearSelect) {
                for (var y = 1901; y <= 2021; y++) {
                    var option = document.createElement('option');
                    option.value = y;
                    option.textContent = y;
                    yearSelect.appendChild(option);
                }
            }
            
            // Helper function to show messages
            function showMessage(text, color) {
                var messageEl = document.getElementById('message');
                if (messageEl) {
                    messageEl.textContent = text;
                    messageEl.style.color = color;
                    messageEl.style.fontSize = '16px';
                    messageEl.style.fontWeight = 'bold';
                    messageEl.classList.remove('d-none');
                }
            }
            
            // Helper function to update data source status
            function updateDataSourceStatus(source, displayName, description) {
                var statusEl = document.getElementById('dataSourceStatus');
                if (statusEl) {
                    statusEl.textContent = 'Current: ' + displayName + ' - ' + description;
                }
            }
            
            // Data source toggle functionality
            var csvRadio = document.getElementById('csvDataSource');
            var kwsRadio = document.getElementById('kwsDataSource');
            
            if (csvRadio && kwsRadio) {
                csvRadio.addEventListener('change', function() {
                    if (this.checked) {
                        switchDataSource('CSV');
                    }
                });
                
                kwsRadio.addEventListener('change', function() {
                    if (this.checked) {
                        switchDataSource('KWS');
                    }
                });
            }
            
            function switchDataSource(source) {
                showMessage('üîÑ Switching to ' + source + ' data source...', 'blue');
                
                fetch('/api/datasource/switch?source=' + source, { method: 'POST' })
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        if (data.status === 'success') {
                            showMessage('‚úÖ ' + data.message, 'green');
                            updateDataSourceStatus(data.currentSource, 
                                source === 'CSV' ? 'CSV Data' : 'KWS Data',
                                source === 'CSV' ? 'Historical CSV rainfall data (1901-2021)' : 'KWS Chennai website data (2000-2025)');
                        } else {
                            showMessage('‚ùå Error: ' + data.message, 'red');
                        }
                    })
                    .catch(function(error) {
                        showMessage('‚ùå Error switching data source: ' + error.message, 'red');
                    });
            }
            
            // Main data fetch button
            var fetchDataBtn = document.getElementById('fetchDataButton');
            if (fetchDataBtn) {
                fetchDataBtn.onclick = function() {
                    var year = document.getElementById('year') ? document.getElementById('year').value : '';
                    var startYear = document.getElementById('startYear') ? document.getElementById('startYear').value : '';
                    var endYear = document.getElementById('endYear') ? document.getElementById('endYear').value : '';
                    
                    var url = '/api/datasource/data?format=html';
                    
                    if (year) {
                        url += '&year=' + year;
                    } else if (startYear && endYear) {
                        url += '&startYear=' + startYear + '&endYear=' + endYear;
                    }
                    
                    showMessage('üîÑ Fetching rainfall data...', 'blue');
                    
                    fetch(url)
                        .then(function(response) { 
                            return response.text(); 
                        })
                        .then(function(data) {
                            var dataElement = document.getElementById('rainfallData');
                            if (dataElement) {
                                dataElement.innerHTML = data;
                            }
                            showMessage('‚úÖ Rainfall data loaded successfully!', 'green');
                        })
                        .catch(function(error) {
                            showMessage('‚ùå Error: ' + error.message, 'red');
                        });
                };
            }
            
            // Statistics button
            var fetchStatsBtn = document.getElementById('fetchStatsButton');
            if (fetchStatsBtn) {
                fetchStatsBtn.onclick = function() {
                    showMessage('üîÑ Generating statistics...', 'blue');
                    
                    fetch('/api/rainfallv2/stats')
                        .then(function(response) { return response.text(); })
                        .then(function(data) {
                            var dataElement = document.getElementById('rainfallData');
                            if (dataElement) {
                                dataElement.innerHTML = data;
                            }
                            showMessage('‚úÖ Statistics generated successfully!', 'green');
                        })
                        .catch(function(error) {
                            showMessage('‚ùå Error: ' + error.message, 'red');
                        });
                };
            }
            
            // Show all charts button
            var showAllChartsBtn = document.getElementById('showAllChartsButton');
            if (showAllChartsBtn) {
                showAllChartsBtn.onclick = function() {
                    showMessage('üîÑ Generating all charts...', 'blue');
                    
                    fetch('/api/rainfallstatsv2/charts/all')
                        .then(function(response) { return response.text(); })
                        .then(function(data) {
                            var dataElement = document.getElementById('rainfallData');
                            if (dataElement) {
                                dataElement.innerHTML = data;
                            }
                            showMessage('‚úÖ All charts generated successfully!', 'green');
                        })
                        .catch(function(error) {
                            showMessage('‚ùå Error: ' + error.message, 'red');
                        });
                };
            }
            
            // Individual chart buttons
            var annualChartBtn = document.getElementById('annualChartButton');
            if (annualChartBtn) {
                annualChartBtn.onclick = function() {
                    showMessage('üîÑ Generating annual rainfall chart...', 'blue');
                    fetch('/api/rainfallv2/charts/annual')
                        .then(function(response) { return response.text(); })
                        .then(function(data) {
                            var dataElement = document.getElementById('rainfallData');
                            if (dataElement) {
                                dataElement.innerHTML = data;
                            }
                            showMessage('‚úÖ Annual chart generated!', 'green');
                        })
                        .catch(function(error) {
                            showMessage('‚ùå Error: ' + error.message, 'red');
                        });
                };
            }
            
            var yearlySvgChartBtn = document.getElementById('yearlySvgChartButton');
            if (yearlySvgChartBtn) {
                yearlySvgChartBtn.onclick = function() {
                    showMessage('üîÑ Generating yearly SVG line chart...', 'blue');
                    fetch('/api/rainfallv2/charts/yearly-svg')
                        .then(function(response) { return response.text(); })
                        .then(function(data) {
                            var dataElement = document.getElementById('rainfallData');
                            if (dataElement) {
                                dataElement.innerHTML = data;
                            }
                            showMessage('‚úÖ Yearly SVG chart generated!', 'green');
                        })
                        .catch(function(error) {
                            showMessage('‚ùå Error: ' + error.message, 'red');
                        });
                };
            }

            var monthlyChartBtn = document.getElementById('monthlyChartButton');
            if (monthlyChartBtn) {
                monthlyChartBtn.onclick = function() {
                    showMessage('üîÑ Generating monthly averages chart...', 'blue');
                    fetch('/api/rainfallv2/charts/monthly')
                        .then(function(response) { return response.text(); })
                        .then(function(data) {
                            var dataElement = document.getElementById('rainfallData');
                            if (dataElement) {
                                dataElement.innerHTML = data;
                            }
                            showMessage('‚úÖ Monthly chart generated!', 'green');
                        })
                        .catch(function(error) {
                            showMessage('‚ùå Error: ' + error.message, 'red');
                        });
                };
            }

            var monthlyTrendChartBtn = document.getElementById('monthlyTrendChartButton');
            if (monthlyTrendChartBtn) {
                monthlyTrendChartBtn.onclick = function() {
                    var month = document.getElementById('monthSelect').value || 1;
                    var monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    var monthName = monthNames[month - 1];
                    showMessage('üîÑ Generating ' + monthName + ' trend chart...', 'blue');
                    fetch('/api/rainfallv2/charts/monthly-trend?month=' + month)
                        .then(function(response) { return response.text(); })
                        .then(function(data) {
                            var dataElement = document.getElementById('rainfallData');
                            if (dataElement) {
                                dataElement.innerHTML = data;
                            }
                            showMessage('‚úÖ ' + monthName + ' trend chart generated!', 'green');
                        })
                        .catch(function(error) {
                            showMessage('‚ùå Error: ' + error.message, 'red');
                        });
                };
            }

            var decadeOffsetChartBtn = document.getElementById('decadeOffsetChartButton');
            if (decadeOffsetChartBtn) {
                decadeOffsetChartBtn.onclick = function() {
                    var offset = document.getElementById('decadeOffsetInput').value || 0;
                    showMessage('üîÑ Generating offset decade chart...', 'blue');
                    fetch('/api/rainfallv2/charts/decade-offset?offset=' + offset)
                        .then(function(response) { return response.text(); })
                        .then(function(data) {
                            var dataElement = document.getElementById('rainfallData');
                            if (dataElement) {
                                dataElement.innerHTML = data;
                            }
                            showMessage('‚úÖ Offset decade chart generated!', 'green');
                        })
                        .catch(function(error) {
                            showMessage('‚ùå Error: ' + error.message, 'red');
                        });
                };
            }
            
            var decadeChartBtn = document.getElementById('decadeChartButton');
            if (decadeChartBtn) {
                decadeChartBtn.onclick = function() {
                    showMessage('üîÑ Generating decade comparison chart...', 'blue');
                    fetch('/api/rainfallv2/charts/decade')
                        .then(function(response) { return response.text(); })
                        .then(function(data) {
                            var dataElement = document.getElementById('rainfallData');
                            if (dataElement) {
                                dataElement.innerHTML = data;
                            }
                            showMessage('‚úÖ Decade chart generated!', 'green');
                        })
                        .catch(function(error) {
                            showMessage('‚ùå Error: ' + error.message, 'red');
                        });
                };
            }
            
            // Chennai Rainfall Trend button
            var chennaiRainfallBtn = document.getElementById('chennaiRainfallButton');
            if (chennaiRainfallBtn) {
                chennaiRainfallBtn.onclick = function() {
                    showMessage('üîÑ Generating Chennai rainfall trend chart...', 'blue');
                    fetch('/climateV2/chennai-rainfall-html')
                        .then(function(response) { return response.text(); })
                        .then(function(data) {
                            var dataElement = document.getElementById('rainfallData');
                            if (dataElement) {
                                dataElement.innerHTML = data;
                            }
                            showMessage('‚úÖ Chennai rainfall trend chart generated!', 'green');
                        })
                        .catch(function(error) {
                            showMessage('‚ùå Error: ' + error.message, 'red');
                        });
                };
            }
            
            // KWS Rainfall Analytics button
            var kwsRainfallAnalyticsBtn = document.getElementById('kwsRainfallAnalyticsButton');
            if (kwsRainfallAnalyticsBtn) {
                kwsRainfallAnalyticsBtn.onclick = function() {
                    showMessage('üîÑ Fetching KWS rainfall analytics...', 'blue');
                    
                    // Temporarily switch to KWS data source for this request
                    fetch('/api/datasource/switch?source=KWS', { method: 'POST' })
                        .then(function(response) { return response.json(); })
                        .then(function(switchResult) {
                            if (switchResult.status === 'success') {
                                // Update radio button to reflect current selection
                                var kwsRadio = document.getElementById('kwsDataSource');
                                if (kwsRadio) kwsRadio.checked = true;
                                updateDataSourceStatus('KWS', 'KWS Data', 'KWS Chennai website data (2000-2025)');
                                
                                // Now fetch the data
                                return fetch('/api/datasource/data?format=html');
                            } else {
                                throw new Error(switchResult.message);
                            }
                        })
                        .then(function(response) { return response.text(); })
                        .then(function(data) {
                            var dataElement = document.getElementById('rainfallData');
                            if (dataElement) {
                                dataElement.innerHTML = data;
                            }
                            showMessage('‚úÖ KWS rainfall analytics loaded successfully!', 'green');
                        })
                        .catch(function(error) {
                            showMessage('‚ùå Error loading KWS analytics: ' + error.message, 'red');
                        });
                };
            }
            
            // Quick action buttons
            var recentYearsBtn = document.getElementById('recentYearsButton');
            if (recentYearsBtn) {
                recentYearsBtn.onclick = function() {
                    document.getElementById('startYear').value = '2012';
                    document.getElementById('endYear').value = '2021';
                    document.getElementById('fetchDataButton').click();
                };
            }
            
            var centuryViewBtn = document.getElementById('centuryViewButton');
            if (centuryViewBtn) {
                centuryViewBtn.onclick = function() {
                    document.getElementById('startYear').value = '1901';
                    document.getElementById('endYear').value = '2000';
                    document.getElementById('fetchDataButton').click();
                };
            }
            
            var modernEraBtn = document.getElementById('modernEraButton');
            if (modernEraBtn) {
                modernEraBtn.onclick = function() {
                    document.getElementById('startYear').value = '2001';
                    document.getElementById('endYear').value = '2021';
                    document.getElementById('fetchDataButton').click();
                };
            }
        });
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
